<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonoShop | The Monolith Store</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div id="app" class="min-h-screen flex flex-col">

    <nav class="glass fixed w-full z-10 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">M</div>
                    <span class="font-bold text-xl tracking-tight">MonoShop</span>
                </div>
                
                <button @click="showCart = true" class="relative p-2 rounded-full hover:bg-slate-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                    <span v-if="cartCount > 0" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/4 -translate-y-1/4 bg-red-500 rounded-full">
                        {{ cartCount }}
                    </span>
                </button>
            </div>
        </div>
    </nav>

    <header class="pt-32 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto w-full text-center">
        <h1 class="text-5xl font-extrabold mb-4">
            The <span class="gradient-text">Monolith</span> Experience
        </h1>
        <p class="text-xl text-slate-500 max-w-2xl mx-auto">
            A seamless shopping experience served by a single, powerful deployment unit. 
            Designed to be strangled by microservices.
        </p>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <div v-if="loading" class="flex justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        </div>

        <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <div v-for="product in products" :key="product.id" 
                 class="bg-white rounded-2xl shadow-sm hover:shadow-xl transition duration-300 border border-slate-100 overflow-hidden group">
                
                <div class="h-48 bg-slate-100 flex items-center justify-center relative overflow-hidden">
                    <span class="text-6xl group-hover:scale-110 transition duration-500">
                        {{ getIcon(product.name) }}
                    </span>
                    <div class="absolute top-3 right-3 bg-white/90 px-2 py-1 rounded-md text-xs font-bold text-slate-500 shadow-sm">
                        Stock: {{ product.stock }}
                    </div>
                </div>

                <div class="p-6">
                    <div class="text-xs font-semibold text-indigo-600 uppercase tracking-wide mb-1">
                        {{ product.category ? product.category.name : 'General' }}
                    </div>
                    <h3 class="text-lg font-bold text-slate-900 mb-2">{{ product.name }}</h3>
                    <div class="flex justify-between items-center mt-4">
                        <span class="text-2xl font-bold text-slate-800">${{ product.price }}</span>
                        <button @click="addToCart(product)" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-md hover:shadow-lg active:scale-95">
                            Add to Cart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="showCart" class="fixed inset-0 overflow-hidden z-50">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" @click="showCart = false"></div>
        <div class="absolute inset-y-0 right-0 max-w-full flex">
            <div class="w-screen max-w-md bg-white shadow-2xl flex flex-col h-full transform transition-transform">
                
                <div class="flex items-center justify-between px-4 py-6 border-b border-slate-100">
                    <h2 class="text-lg font-bold text-slate-900">Shopping Cart</h2>
                    <button @click="showCart = false" class="text-slate-400 hover:text-slate-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-4 space-y-4">
                    <div v-if="cart.length === 0" class="text-center py-20 text-slate-400">
                        <p>Your cart is empty.</p>
                        <p class="text-sm mt-2">Start adding monolithic items!</p>
                    </div>
                    
                    <div v-for="(item, index) in cart" :key="index" class="flex items-center bg-slate-50 p-3 rounded-xl">
                        <div class="h-12 w-12 bg-white rounded-lg flex items-center justify-center text-xl shadow-sm">
                            {{ getIcon(item.name) }}
                        </div>
                        <div class="ml-4 flex-1">
                            <h3 class="font-medium text-slate-900">{{ item.name }}</h3>
                            <p class="text-sm text-slate-500">${{ item.price }} x {{ item.quantity }}</p>
                        </div>
                        <div class="font-bold text-slate-700">${{ item.price * item.quantity }}</div>
                    </div>
                </div>

                <div class="border-t border-slate-100 p-6 bg-slate-50">
                    <div class="flex justify-between text-base font-medium text-slate-900 mb-4">
                        <p>Subtotal</p>
                        <p>${{ cartTotal }}</p>
                    </div>
                    <button @click="checkout" :disabled="processing || cart.length === 0"
                        class="w-full flex justify-center items-center bg-slate-900 text-white px-6 py-4 rounded-xl font-bold hover:bg-slate-800 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <span v-if="!processing">Checkout (User ID: 1)</span>
                        <span v-else class="animate-pulse">Processing Payment...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const products = ref([]);
            const cart = ref([]);
            const showCart = ref(false);
            const loading = ref(true);
            const processing = ref(false);
            // We hardcode User ID 1 for this demo
            const USER_ID = 1;

            // ðŸŽ¨ Helper for Icons
            const getIcon = (name) => {
                if (name.includes('Laptop')) return 'ðŸ’»';
                if (name.includes('Phone')) return 'ðŸ“±';
                if (name.includes('Mouse')) return 'ðŸ–±ï¸';
                if (name.includes('Book')) return 'ðŸ“š';
                if (name.includes('Coffee')) return 'â˜•';
                return 'ðŸ“¦';
            };

            // ðŸ“¡ Fetch Products
            const fetchProducts = async () => {
                try {
                    const res = await fetch('/api/products');
                    products.value = await res.json();
                } catch (e) {
                    console.error(e);
                    showToast("Error connecting to Monolith API", "error");
                } finally {
                    loading.value = false;
                }
            };

            // ðŸ›’ Add to Local Cart (Visual Only until Checkout)
            const addToCart = async (product) => {
                // Call API to sync state
                try {
                    await fetch(`/api/cart/${USER_ID}/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productId: product.id, quantity: 1 })
                    });
                    
                    // Update Local State for UI
                    const existing = cart.value.find(i => i.id === product.id);
                    if (existing) existing.quantity++;
                    else cart.value.push({ ...product, quantity: 1 });
                    
                    showToast(`${product.name} added to cart!`);
                } catch (e) {
                    showToast("Failed to add item", "error");
                }
            };

            // ðŸ’³ Checkout
            const checkout = async () => {
                processing.value = true;
                try {
                    const res = await fetch(`/api/checkout/${USER_ID}`, { method: 'POST' });
                    const data = await res.json();
                    
                    if (res.ok) {
                        showToast(`Order #${data.id} Placed Successfully! ðŸŽ‰`, "success");
                        cart.value = [];
                        showCart.value = false;
                    } else {
                        throw new Error("Payment Failed");
                    }
                } catch (e) {
                    showToast("Checkout Failed. Try again.", "error");
                } finally {
                    processing.value = false;
                }
            };

            const cartCount = computed(() => cart.value.reduce((acc, item) => acc + item.quantity, 0));
            const cartTotal = computed(() => cart.value.reduce((acc, item) => acc + (item.price * item.quantity), 0));

            // ðŸž Toast Notification Helper
            const showToast = (msg, type = 'normal') => {
                Toastify({
                    text: msg,
                    duration: 3000,
                    gravity: "bottom", 
                    position: "right", 
                    style: {
                        background: type === 'error' ? "#ef4444" : type === 'success' ? "#10b981" : "#333",
                        borderRadius: "8px",
                    }
                }).showToast();
            };

            onMounted(() => {
                fetchProducts();
            });

            return { 
                products, cart, showCart, loading, processing, 
                addToCart, checkout, cartCount, cartTotal, getIcon 
            };
        }
    }).mount('#app');
</script>
</body>
</html>